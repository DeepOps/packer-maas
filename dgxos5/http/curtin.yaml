apt:
  preserve_sources_list: false
  sources_list: |
    # network: will be available to target from early stage
    deb [trusted=yes] http://127.0.0.1/ /
  conf: |
    Dpkg::Options {
      "--force-confdef";
      "--force-confold";
    };

install:
  log_file: /var/log/curtin.log
  error_tarfile: /var/log/curtin/curtin-error-logs.tar
  post_files:
    - /var/log/curtin.log
    - /var/log/syslog
  save_install_config: /var/log/curtin-conf.yaml
  save_install_log: /var/log/curtin-install.log
  umount: disabled

kernel:
  package: linux-generic

storage:
  version: 1
  config:
  - id: CHANGE_BOOT_DISK_NAME_1
    type: disk
    ptable: gpt
    path: CHANGE_BOOT_DISK_PATH_1
    name: osdisk
    wipe: superblock-recursive
    grub_device: 1
  - id: CHANGE_BOOT_DISK_NAME_1-part1
    type: partition
    device: CHANGE_BOOT_DISK_NAME_1
    number: 1
    size: 512MB
    flag: boot
  - id: CHANGE_BOOT_DISK_NAME_1-part2
    type: partition
    device: CHANGE_BOOT_DISK_NAME_1
    number: 2
    size: CHANGE_BOOT_DISK_SIZE_1
  - id: CHANGE_BOOT_DISK_NAME_1-part1-fs1
    type: format
    fstype: fat32
    label: efi
    volume: CHANGE_BOOT_DISK_NAME_1-part1
  - id: CHANGE_BOOT_DISK_NAME_1-part2-fs1
    type: format
    fstype: ext4
    label: root
    volume: CHANGE_BOOT_DISK_NAME_1-part2
  - id: CHANGE_BOOT_DISK_NAME_1-mount2
    type: mount
    path: /
    device: CHANGE_BOOT_DISK_NAME_1-part2-fs1
    options: errors=remount-ro
    passno: 1
  - id: boot-mount1
    type: mount
    path: /boot/efi
    device: CHANGE_BOOT_DISK_NAME_1-part1-fs1
    passno: 1

swap:
  size: 0

power_state:
  mode: CHANGE_POWER_STATE
  delay: 5
  message: Installation Complete

sources:
  05_primary:
    uri: "file:///curtin/ubuntu-20.04-server-cloudimg-amd64-root.tar.xz"
    type: "tgz"

reporting:
  mylistener:
    type: journald
    identifier: "curtin-journald"
    level: DEBUG

#early_commands:
#  90_mount_curtin: mount -o bind /curtin/repo/ /var/www/html/
#  91_chown_www: chown www-data:www-data /curtin/repo /var/www/html

late_commands:
  # SSH is configured differently in the cloud images so reconfigure it here to get back
  # to the default settings
  10_conf_ssh: ["curtin", "in-target", "--", "sh", "-c", "dpkg-reconfigure openssh-server"]
  11_conf_ssh: ["curtin", "in-target", "--", "sh", "-c", "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config"]

  23_apt_update: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt update -y"]
  #24_install_pkgs: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends CHANGE_INSTALL_PKGS"]
  #25_unattended_upgrades: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt purge -y unattended-upgrades"]

  # Rewrite sources list
  30_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://us.archive.ubuntu.com/ubuntu/ focal main restricted universe multiverse > /etc/apt/sources.list"]
  31_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://us.archive.ubuntu.com/ubuntu/ focal-updates main restricted universe multiverse >> /etc/apt/sources.list"]
  32_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://security.ubuntu.com/ubuntu/ focal-security main restricted universe multiverse >> /etc/apt/sources.list"]

  # Disable release-upgrade prompt
  40_disable_upgrade: ["curtin", "in-target", "--", "sh", "-c", "sed -i -e 's/^Prompt=.*/Prompt=never/' /etc/update-manager/release-upgrades"]

  # Create user
  50_create_user: ["curtin", "in-target", "--", "sh", "-c",
    "adduser --disabled-password --gecos \"\" --quiet lab"]
  51_add_user_group: ["curtin", "in-target", "--", "sh", "-c",
    "usermod -aG sudo lab"]
  52_set_user_password: ["curtin", "in-target", "--", "sh", "-c",
    "echo 'lab:labuser' | chpasswd"]

  # Copy logs from the install environment into the target
  90_mkdir_installer_logs: mkdir -p $TARGET_MOUNT_POINT/var/log/installer
  91_copy_logs: cp -rf /var/log/* $TARGET_MOUNT_POINT/var/log/installer/
