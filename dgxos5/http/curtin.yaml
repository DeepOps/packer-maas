apt:
  preserve_sources_list: false
  sources_list: |
    # network: will be available to target from early stage
    deb [trusted=yes] http://127.0.0.1/ /
  conf: |
    Dpkg::Options {
      "--force-confdef";
      "--force-confold";
    };

install:
  log_file: /var/log/curtin.log
  error_tarfile: /var/log/curtin/curtin-error-logs.tar
  post_files:
    - /var/log/curtin.log
    - /var/log/syslog
  save_install_config: /var/log/curtin-conf.yaml
  save_install_log: /var/log/curtin-install.log
  umount: disabled

kernel:
  package: linux-generic

  #storage:
  #  version: 1
  #  config:
  #    - id: CHANGE_BOOT_DISK_NAME_1
  #      type: disk
  #      ptable: msdos
  #      path: CHANGE_BOOT_DISK_PATH_1
  #      name: osdisk
  #      wipe: superblock-recursive
  #    - id: CHANGE_BOOT_DISK_NAME_1-part1
  #      type: partition
  #      device: CHANGE_BOOT_DISK_NAME_1
  #      number: 1
  #      size: 512MB
  #    - id: CHANGE_BOOT_DISK_NAME_1-part2
  #      type: partition
  #      device: CHANGE_BOOT_DISK_NAME_1
  #      number: 2
  #      size: CHANGE_BOOT_DISK_SIZE_1
  #    - id: CHANGE_BOOT_DISK_NAME_1-part1-fs1
  #      type: format
  #      fstype: fat32
  #      label: efi
  #      volume: CHANGE_BOOT_DISK_NAME_1-part1
  #    - id: CHANGE_BOOT_DISK_NAME_1-part2-fs1
  #      type: format
  #      fstype: ext4
  #      label: root
  #      volume: CHANGE_BOOT_DISK_NAME_1-part2
  #    - id: CHANGE_BOOT_DISK_NAME_1-mount2
  #      type: mount
  #      path: /
  #      device: CHANGE_BOOT_DISK_NAME_1-part2-fs1
  #      options: errors=remount-ro
  #      passno: 1
  #    - id: boot-mount1
  #      type: mount
  #      path: /boot/efi
  #      device: CHANGE_BOOT_DISK_NAME_1-part1-fs1
  #      passno: 1

swap:
  size: 0

sources:
  05_primary:
    uri: "file:///curtin/ubuntu-20.04-server-cloudimg-amd64-root.tar.xz"
    type: "tgz"

reporting:
  mylistener:
    type: journald
    identifier: "curtin-journald"
    level: DEBUG

# Running just a couple stages is useful for debugging
#stages: ["early", "late"]
stages: ["early", "partitioning", "network", "extract", "late"]

early_commands:
  # stop the SSH server daemon so Packer can't connect yet
  10_stop_ssh: ["systemctl", "stop", "ssh"]

late_commands:
  # SSH is configured differently in the cloud images so reconfigure it here to get back
  # to the default settings
  10_conf_ssh: ["curtin", "in-target", "--", "sh", "-c", "dpkg-reconfigure openssh-server"]
  11_conf_ssh: ["curtin", "in-target", "--", "sh", "-c", "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config"]

  # prevent services from starting automatically when installing
  12_do_stuff: ["curtin", "in-target", "--", "sh", "-c", "echo -e '#!/bin/sh\nexit 101' | install -m 755 /dev/stdin /usr/sbin/policy-rc.d"]

  23_apt_update: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt-get update -y"]
  #24_install_pkgs: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends CHANGE_INSTALL_PKGS"]
  #25_unattended_upgrades: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt-get purge -y unattended-upgrades"]

  # Rewrite sources list
  30_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://us.archive.ubuntu.com/ubuntu/ focal main restricted universe multiverse > /etc/apt/sources.list"]
  31_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://us.archive.ubuntu.com/ubuntu/ focal-updates main restricted universe multiverse >> /etc/apt/sources.list"]
  32_write_sources: ["curtin", "in-target", "--", "sh", "-c", "echo deb http://security.ubuntu.com/ubuntu/ focal-security main restricted universe multiverse >> /etc/apt/sources.list"]

  # Disable release-upgrade prompt
  40_disable_upgrade: ["curtin", "in-target", "--", "sh", "-c", "sed -i -e 's/^Prompt=.*/Prompt=never/' /etc/update-manager/release-upgrades"]

  # Create user
  50_create_user: ["curtin", "in-target", "--", "sh", "-c",
    "adduser --disabled-password --gecos \"\" --quiet lab"]
  51_add_user_group: ["curtin", "in-target", "--", "sh", "-c",
    "usermod -aG sudo lab"]
  52_set_user_password: ["curtin", "in-target", "--", "sh", "-c",
    "echo 'lab:labuser' | chpasswd"]

  # Copy logs from the install environment into the target
  80_mkdir_installer_logs: mkdir -p $TARGET_MOUNT_POINT/var/log/installer
  81_copy_logs: cp -rf /var/log/* $TARGET_MOUNT_POINT/var/log/installer/

  # remove file which prevents services from starting automatically when installing
  82_do_stuff: ["curtin", "in-target", "--", "sh", "-c", "rm -f /usr/sbin/policy-rc.d"]
  #83_do_stuff: ["curtin", "in-target", "--", "sh", "-c", "rm -f /etc/default/grub.d/50-curtin-settings.cfg"]
  84_do_stuff: ["curtin", "in-target", "--", "sh", "-c", "DEBIAN_FRONTEND=noninteractive apt-get remove -y --autoremove --purge grub*"]
  85_do_stuff: ["curtin", "in-target", "--", "sh", "-c", "rm -rf /boot/"]
  86_do_stuff: ["curtin", "in-target", "--", "sh", "-c", "mkdir -p /boot/"]

  # Enable SSH last when using Packer
  90_conf_ssh: ["sed", "-i", "s/PasswordAuthentication no/PasswordAuthentication yes/", "/etc/ssh/sshd_config"]
  91_conf_ssh: ["sed", "-i", "s/#PermitRootLogin prohibit-password/PermitRootLogin yes/", "/etc/ssh/sshd_config"]
  92_set_root_pw: ["sh", "-c", "echo root:root | chpasswd"]
  93_start_ssh: ["systemctl", "start", "ssh"]

  # Sleep just in case so Packer has a chance to shut down the machine vs the init script ending
  # This won't actually run for 600 seconds
  94_sleep: ["sleep", "600"]
